<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>How to choose the number of topics/partitions in a Kafka cluster? | BurningBright</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">How to choose the number of topics/partitions in a Kafka cluster?</h1><a id="logo" href="/.">BurningBright</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">How to choose the number of topics/partitions in a Kafka cluster?</h1><div class="post-meta">Nov 12, 2018<span> | </span><span class="category"><a href="/categories/db/">db</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css"><p>This is a common question asked by many Kafka users.<br>The goal of this post is to explain a few important determining factors and provide a few simple formulas.</p>
<h2 id="More-Partitions-Lead-to-Higher-Throughput"><a href="#More-Partitions-Lead-to-Higher-Throughput" class="headerlink" title="More Partitions Lead to Higher Throughput"></a>More Partitions Lead to Higher Throughput</h2><p>The first thing to understand is that <strong>a topic partition is the unit of parallelism in Kafka</strong>.<br>On both the producer and the broker side, writes to different partitions can be done fully in parallel.<br>So expensive operations such as compression can utilize more hardware resources.<br>On the consumer side, Kafka always gives a single partition’s data to one consumer thread.<br>Thus, the degree of parallelism in the consumer (within a consumer group) is bounded by the number of partitions being consumed.<br>Therefore, in general, <strong>the more partitions</strong> there are in a Kafka cluster, <strong>the higher the throughput</strong> one can achieve.</p>
<p>A rough formula for picking the number of partitions is based on throughput.<br>You measure the throughout that you can achieve on a single partition for production (call it p) and consumption (call it c).<br>Let’s say your target throughput is t.<br>Then you need to have at least max(t/p, t/c) partitions.<br>The per-partition throughput that one can achieve on the producer depends on configurations such as the batching size, compression codec, type of acknowledgement, replication factor, etc.<br>However, in general, <strong>one can produce at 10s of MB/sec on just a single partition</strong> as shown in this benchmark.<br>The consumer throughput is often application dependent since it corresponds to how fast <strong>the consumer logic can process each message</strong>.<br>So, you really need to measure it.</p>
<p>Although it’s possible to increase the number of partitions over time, one has to be careful if messages are produced with keys.<br>When publishing a keyed message, Kafka deterministically maps the message to a partition based on the hash of the key.<br>This provides a guarantee that <strong>messages with the same key are always routed to the same partition</strong>.<br>This guarantee can be important for certain applications since messages within a partition are always delivered in order to the consumer.<br>If the number of partitions changes, such a guarantee may no longer hold.<br>To avoid this situation, a common practice is to over-partition a bit.<br><strong>Basically, you determine the number of partitions based on a future target throughput, say for one or two years later.</strong><br>Initially, you can just have a small Kafka cluster based on your current throughput.<br>Over time, you can add more brokers to the cluster and proportionally move a subset of the existing partitions to the new brokers (which can be done online).<br>This way, you can keep up with the throughput growth without breaking the semantics in the application when keys are used.</p>
<p>In addition to throughput, there are a few other factors that are worth considering when choosing the number of partitions.<br>As you will see, in some cases, having too many partitions may also have negative impact.</p>
<h2 id="More-Partitions-Requires-More-Open-File-Handles"><a href="#More-Partitions-Requires-More-Open-File-Handles" class="headerlink" title="More Partitions Requires More Open File Handles"></a>More Partitions Requires More Open File Handles</h2><p>Each partition maps to a directory in the file system in the broker.<br>Within that log directory, there will be two files (one for the index and another for the actual data) per log segment.<br>Currently, in Kafka, each broker opens a file handle of both the index and the data file of every log segment.<br>So, the more partitions, the higher that one needs to configure the open file handle limit in the underlying operating system.<br>This is mostly just a configuration issue.<br>We have seen production Kafka clusters running with more than 30 thousand open file handles per broker.</p>
<h2 id="More-Partitions-May-Increase-Unavailability"><a href="#More-Partitions-May-Increase-Unavailability" class="headerlink" title="More Partitions May Increase Unavailability"></a>More Partitions May Increase Unavailability</h2><p>Kafka supports intra-cluster replication, which provides higher availability and durability.<br><strong>A partition can have multiple replicas</strong>, each stored on a different broker.<br>One of the replicas is designated as the leader and the rest of the replicas are followers.<br>Internally, Kafka manages all those replicas automatically and makes sure that they are kept in sync.<br>Both the producer and the consumer requests to a partition are served on the leader replica.<br>When a broker fails, partitions with a leader on that broker become temporarily unavailable.<br>Kafka will automatically move the leader of those unavailable partitions to some other replicas to continue serving the client requests.<br>This process is done by one of the Kafka brokers designated as the controller.<br>It involves reading and writing some metadata for each affected partition in ZooKeeper.<br>Currently, operations to ZooKeeper are done serially in the controller.</p>
<p>In the common case when a broker is shut down cleanly, the controller will proactively move the leaders off the shutting down broker one at a time.<br>The moving of a single leader takes only a few milliseconds.<br>So, from the clients perspective, there is only a small window of unavailability during a clean broker shutdown.</p>
<p>However, when a broker is shut down uncleanly (e.g., kill -9), the observed unavailability could be proportional to the number of partitions.<br>Suppose that a broker has a total of 2000 partitions, each with 2 replicas.<br>Roughly, this broker will be the leader for about 1000 partitions.<br>When this broker fails uncleanly, all those 1000 partitions become unavailable at exactly the same time.<br>Suppose that it takes 5 ms to elect a new leader for a single partition.<br>It will take up to 5 seconds to elect the new leader for all 1000 partitions.<br>So, for some partitions, their observed unavailability can be 5 seconds plus the time taken to detect the failure.</p>
<p>If one is unlucky, the failed broker may be the controller.<br>In this case, the process of electing the new leaders won’t start until the controller fails over to a new broker.<br>The controller failover happens automatically, but requires the new controller to read some metadata for every partition from ZooKeeper during initialization.<br>For example, if there are 10,000 partitions in the Kafka cluster and initializing the metadata from ZooKeeper takes 2 ms per partition, this can add 20 more seconds to the unavailability window.</p>
<p>In general, unclean failures are rare.<br>However, if one cares about availability in those rare cases, it’s probably better to limit the number of partitions per broker to two to four thousand and the total number of partitions in the cluster to low tens of thousand.</p>
<h2 id="More-Partitions-May-Increase-End-to-end-Latency"><a href="#More-Partitions-May-Increase-End-to-end-Latency" class="headerlink" title="More Partitions May Increase End-to-end Latency"></a>More Partitions May Increase End-to-end Latency</h2><p>The end-to-end latency in Kafka is defined by the time from when a message is published by the producer to when the message is read by the consumer.<br>Kafka only exposes a message to a consumer after it has been committed, i.e., when the message is replicated to all the in-sync replicas.<br>So, the time to commit a message can be a significant portion of the end-to-end latency.<br>By default, a Kafka broker only uses a single thread to replicate data from another broker, for all partitions that share replicas between the two brokers.<br>Our experiments show that replicating 1000 partitions from one broker to another can add about 20 ms latency, which implies that the end-to-end latency is at least 20 ms.<br>This can be too high for some real-time applications.</p>
<p>Note that this issue is alleviated on a larger cluster.<br>For example, suppose that there are 1000 partition leaders on a broker and there are 10 other brokers in the same Kafka cluster.<br>Each of the remaining 10 brokers only needs to fetch 100 partitions from the first broker on average.<br>Therefore, the added latency due to committing a message will be just a few ms, instead of tens of ms.</p>
<p>As a rule of thumb, if you care about latency, it’s probably a good idea to limit the number of partitions per broker to 100 x b x r, where b is the number of brokers in a Kafka cluster and r is the replication factor.</p>
<h2 id="More-Partitions-May-Require-More-Memory-In-the-Client"><a href="#More-Partitions-May-Require-More-Memory-In-the-Client" class="headerlink" title="More Partitions May Require More Memory In the Client"></a>More Partitions May Require More Memory In the Client</h2><p>In the most recent 0.8.2 release which we ship with the Confluent Platform 1.0, we have developed a more efficient Java producer.<br>One of the nice features of the new producer is that it allows users to set an upper bound on the amount of memory used for buffering incoming messages.<br>Internally, the producer buffers messages per partition.<br>After enough data has been accumulated or enough time has passed, the accumulated messages are removed from the buffer and sent to the broker.</p>
<p>If one increases the number of partitions, message will be accumulated in more partitions in the producer.<br>The aggregate amount of memory used may now exceed the configured memory limit.<br>When this happens, the producer has to either block or drop any new message, neither of which is ideal.<br>To prevent this from happening, one will need to reconfigure the producer with a larger memory size.</p>
<p>As a rule of thumb, to achieve good throughput, one should allocate at least a few tens of KB per partition being produced in the producer and adjust the total amount of memory if the number of partitions increases significantly.</p>
<p>A similar issue exists in the consumer as well.<br>The consumer fetches a batch of messages per partition.<br>The more partitions that a consumer consumes, the more memory it needs.<br>However, this is typically only an issue for consumers that are not real time.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>In general, more partitions in a Kafka cluster leads to higher throughput.<br>However, one does have to be aware of the potential impact of having too many partitions in total or per broker on things like availability and latency.<br>In the future, we do plan to improve some of those limitations to make Kafka more scalable in terms of the number of partitions.</p>
<p><a href="https://blog.csdn.net/kwengelie/article/details/51150114" target="_blank" rel="noopener">https://blog.csdn.net/kwengelie/article/details/51150114</a><br><a href="https://www.confluent.io/blog/author/jun-rao/" target="_blank" rel="noopener">https://www.confluent.io/blog/author/jun-rao/</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://linchenguang.com/2018/11/12/How-to-choose-the-number-of-topics-partitions-in-a-Kafka-cluster/" data-id="cjr4c2nxx00jku3mv5dg9nkp1" class="article-share-link">Share</a><div class="tags"><a href="/tags/kafka/">kafka</a></div><div class="post-nav"><a href="/2018/11/22/Spring-Boot-KafkaListener-concurrent/" class="pre">Spring Boot KafkaListener concurrent</a><a href="/2018/11/06/kafka-consumer-group/" class="next">kafka consumer group</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://linchenguang.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cryptograpy/">cryptograpy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/version/">version</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/latex/">latex</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/math/">math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ml/">ml</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/raspberry/">raspberry</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/regex/">regex</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/search/">search</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/theory/">theory</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/version/">version</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/sort/" style="font-size: 15px;">sort</a> <a href="/tags/hello/" style="font-size: 15px;">hello</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/yml/" style="font-size: 15px;">yml</a> <a href="/tags/encode/" style="font-size: 15px;">encode</a> <a href="/tags/regex/" style="font-size: 15px;">regex</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/array/" style="font-size: 15px;">array</a> <a href="/tags/compress/" style="font-size: 15px;">compress</a> <a href="/tags/lucene/" style="font-size: 15px;">lucene</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/fundamental/" style="font-size: 15px;">fundamental</a> <a href="/tags/constructure/" style="font-size: 15px;">constructure</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/literal/" style="font-size: 15px;">literal</a> <a href="/tags/ascii/" style="font-size: 15px;">ascii</a> <a href="/tags/anchor/" style="font-size: 15px;">anchor</a> <a href="/tags/syntax/" style="font-size: 15px;">syntax</a> <a href="/tags/guide/" style="font-size: 15px;">guide</a> <a href="/tags/group/" style="font-size: 15px;">group</a> <a href="/tags/keyboard/" style="font-size: 15px;">keyboard</a> <a href="/tags/repetition/" style="font-size: 15px;">repetition</a> <a href="/tags/command/" style="font-size: 15px;">command</a> <a href="/tags/rename/" style="font-size: 15px;">rename</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/difference/" style="font-size: 15px;">difference</a> <a href="/tags/selector/" style="font-size: 15px;">selector</a> <a href="/tags/file/" style="font-size: 15px;">file</a> <a href="/tags/rsa/" style="font-size: 15px;">rsa</a> <a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/factor/" style="font-size: 15px;">factor</a> <a href="/tags/inverse/" style="font-size: 15px;">inverse</a> <a href="/tags/math/" style="font-size: 15px;">math</a> <a href="/tags/first/" style="font-size: 15px;">first</a> <a href="/tags/probability/" style="font-size: 15px;">probability</a> <a href="/tags/function/" style="font-size: 15px;">function</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/elastic/" style="font-size: 15px;">elastic</a> <a href="/tags/character/" style="font-size: 15px;">character</a> <a href="/tags/proxy/" style="font-size: 15px;">proxy</a> <a href="/tags/pattern/" style="font-size: 15px;">pattern</a> <a href="/tags/freemarker/" style="font-size: 15px;">freemarker</a> <a href="/tags/security/" style="font-size: 15px;">security</a> <a href="/tags/shiro/" style="font-size: 15px;">shiro</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/btree/" style="font-size: 15px;">btree</a> <a href="/tags/hash/" style="font-size: 15px;">hash</a> <a href="/tags/strategy/" style="font-size: 15px;">strategy</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/memcached/" style="font-size: 15px;">memcached</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/quantum/" style="font-size: 15px;">quantum</a> <a href="/tags/config/" style="font-size: 15px;">config</a> <a href="/tags/thread/" style="font-size: 15px;">thread</a> <a href="/tags/linear/" style="font-size: 15px;">linear</a> <a href="/tags/graph/" style="font-size: 15px;">graph</a> <a href="/tags/computer/" style="font-size: 15px;">computer</a> <a href="/tags/string/" style="font-size: 15px;">string</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/install/" style="font-size: 15px;">install</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/solr/" style="font-size: 15px;">solr</a> <a href="/tags/unicode/" style="font-size: 15px;">unicode</a> <a href="/tags/symbol/" style="font-size: 15px;">symbol</a> <a href="/tags/protocol/" style="font-size: 15px;">protocol</a> <a href="/tags/audio/" style="font-size: 15px;">audio</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/20/Throttling-pattern/">Throttling pattern</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/10/bayes-formula-comprehend/">bayes' formula comprehend</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/07/hide-csdn-ad-in-chrome/">hide csdn ad in chrome</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/29/compile-spring-5-x-in-idea/">compile spring 5.x in idea</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/Bayes-theorem/">Bayes' theorem</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/29/thread-pool-anaylsis/">thread pool anaylsis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/27/troubleshooting-high-cpu-occupancy-rate/">troubleshooting high cpu occupancy rate</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/22/Lucene-fmn-index-output-format/">Lucene fmn index & output type</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/21/download-outside-GFW/">download outside GFW</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/11/Nginx-https-in-aws/">Nginx https in aws</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.linchenguang.com/sql" title="sql" target="_blank">sql</a><ul></ul><a href="http://www.linchenguang.com/cron" title="cron" target="_blank">cron</a><ul></ul><a href="http://www.linchenguang.com/regex" title="regex" target="_blank">regex</a><ul></ul><a href="http://www.linchenguang.com/keyboard" title="keyboard" target="_blank">keyboard</a><ul></ul><a href="http://www.linchenguang.com/toy" title="toy" target="_blank">toy</a><ul></ul><a href="http://www.linchenguang.com/KaTeX" title="KaTeX" target="_blank">KaTeX</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">BurningBright.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>